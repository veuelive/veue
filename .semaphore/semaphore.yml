version: v1.0
name: Veue
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804

auto_cancel:
  running:
    when: "branch != 'main'"

blocks:
  - name: Rspec
    task:
      env_vars:
        - name: DATABASE_URL
          value: 'postgresql://postgres:@0.0.0.0:5432/myapp_test'
        - name: RAILS_ENV
          value: test
        - name: DATABASE_CLEANER_ALLOW_REMOTE_DATABASE_URL
          value: 'true'
      prologue:
        commands:
          # Checkout code from Git repository. This step is mandatory if the
          # job is to work with your code.
          # Optionally you may use --use-cache flag to avoid roundtrip to
          # remote repository.
          # See https://docs.semaphoreci.com/article/54-toolbox-reference#checkout
          - checkout
          # Restore dependencies from cache.
          # Read about caching: https://docs.semaphoreci.com/article/149-caching
          - cache restore

          - git -C /home/semaphore/.rbenv/plugins/ruby-build pull
          - sem-version ruby 2.7.3
          - sem-version node 14.16.0
          - bundle config set deployment 'true'
          - bundle config set path 'vendor/bundle'
          - bundle install
          - yarn install
          - 'bundle exec rake webpacker:compile'
          - gem install semaphore_test_boosters
          - cache store
          - sem-service start postgres 11
          - 'bundle exec rake db:setup'
      jobs:
        - name: Rspec Tests
          parallelism: 5
          commands:
            - rspec_booster --job $SEMAPHORE_JOB_INDEX/$SEMAPHORE_JOB_COUNT
        - name: eslint
          commands:
            - yarn eslint app/ spec/ 